---
title: "blog data prep"
author: "Calum Nicholson"
date: "2023-09-05"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(here)
library(ggconsort)
library(qwraps2)
```

# Code for Blog Post

Hi Mark, The code for each output is below, They wont run because I haven't included the data but a bit of background if you need it:

  - Consort Diagram: This is using a data flow that we to select patients for the registry, `el.sample` is a sample of the eligibility table, which contains a series of TRUE/FALSE flags that are used to determine the eligibility flags for each step (where "el_final" is the final eligibility and "has_dx" or "has_proc" flag whether diagnosis or procedure data are present).
  
  - Summary Table: This is a sample that from a recent poster of patients who had completed a DASS-21 survey.

### Build Consort Diagram (figure 1 for blog)

``` {r}
study_cohorts <- el.sample %>%
                  cohort_start("Assessed for eligibility") %>%
                  # Define cohorts using named expressions
                  cohort_define(
                    # Patient with missing diagnosis or procedure codes
                    missing = .full %>% filter(!has_dx & !has_proc), 
                    # only patients with diagnosis or procedure considered
                    considered = .full %>% filter(has_dx | has_proc),
                    # patients without congential heart disease
                    ineligibile = .full %>% filter(!el_final & (has_dx | has_proc)),
                    # patients with congential Heart Disease
                    eligibile = .full %>% filter(el_final)) %>%
                  # Provide text table for cohorts
                  cohort_label(
                    missing = "No Diagnosis or Procedure",
                    considered = "Patients considered for eligibility",
                    ineligibile = "Ineligibile Patients",
                    eligibile = "Eligibile Patients")

study_consort <- study_cohorts %>% 
                  # Add the boxes
                  consort_box_add(
                    "full", 0, 50, cohort_count_adorn(study_cohorts, .full)) %>%
                  consort_box_add(
                    "considered", 0, 30, cohort_count_adorn(study_cohorts, considered)) %>%
                  consort_box_add(
                    "eligibile", 0, 10, cohort_count_adorn(study_cohorts, eligibile)) %>%
                  consort_box_add(
                    "missing", 5, 40, cohort_count_adorn(study_cohorts, missing)) %>%
                  consort_box_add(
                    "ineligibile", 5, 20, cohort_count_adorn(study_cohorts, ineligibile)) %>%
                  # Add the arrows
                  consort_arrow_add(
                    start = "full", start_side = "bottom",
                    end = "considered", end_side = "top") %>%
                  consort_arrow_add(
                    start = "considered", start_side = "bottom",
                    end = "eligibile", end_side = "top") %>%
                  consort_arrow_add(
                    end = "missing", end_side = "left", start_x = 0, start_y = 40) %>%
                  consort_arrow_add(
                    end = "ineligibile", end_side = "left", start_x = 0, start_y = 20) %>% 
              # Plot with ggplot
              ggplot() +
              geom_consort() +
              theme_consort(margin_h = 15, margin_v = 1)

study_consort
```

``` {r}
#ggsave("consort_flow.jpg", study_consort)
```

### Summary Table (Figure 2 for Blog)

This code wont run, its from a separate project and the data are not loaded in for it, just here for an example of the summary table

``` {r}
options(qwraps_markup = "markdown")

# Create Table Template for DASS-21 Summary
dass_level_summary <-
  list("Depression" =
         list("Normal" = ~ n_perc0(dass_dep_level_clean == "Normal"),
              "Mild" = ~ n_perc0(dass_dep_level_clean == "Mild"),
              "Moderate" = ~ n_perc0(dass_dep_level_clean == "Moderate"),
              "Severe" = ~ n_perc0(dass_dep_level_clean == "Severe"),
              "Extemely Severe" = ~ n_perc0(dass_dep_level_clean == "Extemely Severe"),
              ),
       "Anxiety" =
         list("Normal" = ~ n_perc0(dass_anx_level_clean == "Normal"),
              "Mild" = ~ n_perc0(dass_anx_level_clean == "Mild"),
              "Moderate" = ~ n_perc0(dass_anx_level_clean == "Moderate"),
              "Severe" = ~ n_perc0(dass_anx_level_clean == "Severe"),
              "Extemely Severe" = ~ n_perc0(dass_anx_level_clean == "Extemely Severe"),
              ),
       "Stress" = 
         list("Normal" = ~ n_perc0(dass_stress_level_clean == "Normal"),
              "Mild" = ~ n_perc0(dass_stress_level_clean == "Mild"),
              "Moderate" = ~ n_perc0(dass_stress_level_clean == "Moderate"),
              "Severe" = ~ n_perc0(dass_stress_level_clean == "Severe"),
              "Extemely Severe" = ~ n_perc0(dass_stress_level_clean == "Extemely Severe"),
              )
       )

# Summary Table for whole dataset
dass.level.whole <- summary_table(poster.population, dass_level_summary)
# Summary table stratified by complexity
dass.level.complexity <- summary)table(dyplr::group_by(poster.population, chd_complexity), dass_level_summary)

# Combine both tables
dass.level <- cbind(dass.level.whole, dass.level.complexity)

# Print table with title
print(dass.level,
      rtitle = "DASS-21 Level - Summary Statistics",
      cnames( c(paste("All (N -", poster.population %>% nrow, ")", sep = ""),
                paste("Mild (N -", poster.population %>% filter(chd_complexity = "Mild") %>% nrow, ")", sep = ""),
                paste("Moderate (N -", poster.population %>% filter(chd_complexity = "Moderate") %>% nrow, ")", sep = ""),
                paste("Severe (N -", poster.population %>% filter(chd_complexity = "Severe") %>% nrow, ")", sep = "")
                )
              )
)

```





